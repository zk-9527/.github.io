<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>我的常用停車場</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 20px; }
  h2 { margin-bottom: 10px; }
  .lot { border: 1px solid #ccc; padding: 10px; margin: 8px 0; border-radius: 8px; }
  .name { font-weight: bold; font-size: 18px; }
  .remain { font-size: 20px; margin: 6px 0; }
  .ok { color: green; }
  .warn { color: orange; }
  .bad { color: red; }
  .time { font-size: 12px; color: #555; }
</style>
</head>
<body>
<h2>🚗 我的常用停車場狀況</h2>
<div id="list">讀取中...</div>

<script>
const LOT_INFO = "https://data.taipei/api/v1/dataset/1bcd8f0a-4de3-4fbb-9a39-6c83dbe8c7e1?scope=resourceAquire";
const LOT_LIVE = "https://data.taipei/api/v1/dataset/2b73b02b-d4f0-40db-a7d6-03760b36b6a2?scope=resourceAquire";

// 🔹改這裡：填你常用的停車場名稱（要和官方資料一致）
const MY_LIST = ["中崙高中地下停車場", "市府轉運站停車場"];

function statusClass(remain, total) {
  if (!total) return "";
  const r = remain / total;
  if (r >= 0.3) return "ok";
  if (r >= 0.1) return "warn";
  return "bad";
}

async function load() {
  try {
    // 基本資料
    const infoRes = await fetch(LOT_INFO);
    const infoJson = await infoRes.json();
    const infos = infoJson.result?.results || [];
    const byName = new Map(infos.map(p => [p.name, p]));
    const byId = new Map(infos.map(p => [p.id, p]));

    // 即時資料
    const liveRes = await fetch(LOT_LIVE);
    const liveJson = await liveRes.json();
    const lives = liveJson.result?.results || [];
    const liveById = new Map(lives.map(p => [p.id, p]));

    // 顯示
    let html = "";
    for (let name of MY_LIST) {
      const info = byName.get(name);
      if (!info) {
        html += `<div class="lot"><div class="name">${name}</div><div>❌ 找不到基本資料</div></div>`;
        continue;
      }
      const live = liveById.get(info.id);
      if (!live) {
        html += `<div class="lot"><div class="name">${name}</div><div>❌ 找不到即時資料</div></div>`;
        continue;
      }
      const remain = Number(live.availablecar || 0);
      const total = Number(live.totalcar || info.totalcar || 0);
      const time = live.srcUpdateTime || live.update_time || "";

      const cls = statusClass(remain, total);
      html += `
        <div class="lot">
          <div class="name">${info.name}</div>
          <div class="remain ${cls}">剩餘 ${remain} / ${total}</div>
          <div class="time">更新時間：${time}</div>
          <div class="time">地址：${info.address || ""}</div>
        </div>
      `;
    }
    document.getElementById("list").innerHTML = html;
  } catch (e) {
    document.getElementById("list").textContent = "讀取失敗：" + e;
  }
}

// 首次載入 + 每 60 秒更新一次
load();
setInterval(load, 60000);
</script>
</body>
</html>
