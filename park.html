<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>æˆ‘çš„å¸¸ç”¨åœè»Šå ´</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 20px; }
  h2 { margin-bottom: 10px; }
  .lot { border: 1px solid #ccc; padding: 10px; margin: 8px 0; border-radius: 8px; }
  .name { font-weight: bold; font-size: 18px; }
  .remain { font-size: 20px; margin: 6px 0; }
  .ok { color: green; }
  .warn { color: orange; }
  .bad { color: red; }
  .time { font-size: 12px; color: #555; }
</style>
</head>
<body>
<h2>ğŸš— æˆ‘çš„å¸¸ç”¨åœè»Šå ´ç‹€æ³</h2>
<div id="list">è®€å–ä¸­...</div>

<script>
const LOT_INFO = "https://data.taipei/api/v1/dataset/1bcd8f0a-4de3-4fbb-9a39-6c83dbe8c7e1?scope=resourceAquire";
const LOT_LIVE = "https://data.taipei/api/v1/dataset/2b73b02b-d4f0-40db-a7d6-03760b36b6a2?scope=resourceAquire";

// ğŸ”¹æ”¹é€™è£¡ï¼šå¡«ä½ å¸¸ç”¨çš„åœè»Šå ´åç¨±ï¼ˆè¦å’Œå®˜æ–¹è³‡æ–™ä¸€è‡´ï¼‰
const MY_LIST = ["ä¸­å´™é«˜ä¸­åœ°ä¸‹åœè»Šå ´", "å¸‚åºœè½‰é‹ç«™åœè»Šå ´"];

function statusClass(remain, total) {
  if (!total) return "";
  const r = remain / total;
  if (r >= 0.3) return "ok";
  if (r >= 0.1) return "warn";
  return "bad";
}

async function load() {
  try {
    // åŸºæœ¬è³‡æ–™
    const infoRes = await fetch(LOT_INFO);
    const infoJson = await infoRes.json();
    const infos = infoJson.result?.results || [];
    const byName = new Map(infos.map(p => [p.name, p]));
    const byId = new Map(infos.map(p => [p.id, p]));

    // å³æ™‚è³‡æ–™
    const liveRes = await fetch(LOT_LIVE);
    const liveJson = await liveRes.json();
    const lives = liveJson.result?.results || [];
    const liveById = new Map(lives.map(p => [p.id, p]));

    // é¡¯ç¤º
    let html = "";
    for (let name of MY_LIST) {
      const info = byName.get(name);
      if (!info) {
        html += `<div class="lot"><div class="name">${name}</div><div>âŒ æ‰¾ä¸åˆ°åŸºæœ¬è³‡æ–™</div></div>`;
        continue;
      }
      const live = liveById.get(info.id);
      if (!live) {
        html += `<div class="lot"><div class="name">${name}</div><div>âŒ æ‰¾ä¸åˆ°å³æ™‚è³‡æ–™</div></div>`;
        continue;
      }
      const remain = Number(live.availablecar || 0);
      const total = Number(live.totalcar || info.totalcar || 0);
      const time = live.srcUpdateTime || live.update_time || "";

      const cls = statusClass(remain, total);
      html += `
        <div class="lot">
          <div class="name">${info.name}</div>
          <div class="remain ${cls}">å‰©é¤˜ ${remain} / ${total}</div>
          <div class="time">æ›´æ–°æ™‚é–“ï¼š${time}</div>
          <div class="time">åœ°å€ï¼š${info.address || ""}</div>
        </div>
      `;
    }
    document.getElementById("list").innerHTML = html;
  } catch (e) {
    document.getElementById("list").textContent = "è®€å–å¤±æ•—ï¼š" + e;
  }
}

// é¦–æ¬¡è¼‰å…¥ + æ¯ 60 ç§’æ›´æ–°ä¸€æ¬¡
load();
setInterval(load, 60000);
</script>
</body>
</html>
